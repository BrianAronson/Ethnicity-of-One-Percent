*Fix missing savings value info for 1996.  Unfortunately, most of this code is unecessary, since only the family heads were asked their savings in 1996;
Data SippTemp;
	set Sipp.combined2;
run;
proc sort data=sipptemp;
	by year ssuid shhadid refperson;
run; 
Data Sipptemp;
	set sipptemp;
	if year=1996 then do;
	thhthrif=0;
	if lag(refperson)= 1 then thhthrif=taltb;
		else thhthrif=taltb+lag(thhthrif);
		thhthrif1 = lag(thhthrif);
	end;
	run;

*Create all variables;
Data SippTemp;
	set SippTemp;

	*Missing to ".";
	Array variables _numeric_;
		do over variables;
		if variables=-1 then variables=.;
		end;
	*recode monthly income to annual income;
	Income=thearn*12;  

	*Education variables;
		if eeducate<39 & eeducate~=. then LessThanHS=1;
			else if eeducate~=. then LessThanHS=0;
		if eeducate=39 then HSGraduate=1;
			else if eeducate~=. then HSGraduate=0;
		if eeducate>39 & eeducate<44 then SomeCollege=1;
			else if eeducate~=. then SomeCollege=0;
		if eeducate=44 then Bachelors=1;
			else if eeducate~=. then Bachelors=0;
		if eeducate>44 then AdvancedDegree=1;
			else if eeducate~=. then AdvancedDegree=0;
		if LessThanHS=1 then Education=0;
		if HSGraduate=1 then Education=1;
		if SomeCollege=1 then Education=2;
		if Bachelors=1 then Education=3;
		if AdvancedDegree=1 then Education=4;
	*Race dummies;
		If eorigin=1 & (year=2008 | year=2004) then Latino=1;
			Else if eorigin>19 & eorigin<30 then Latino=1;
			Else Latino=0;
		if erace=1 & Latino~=1 then White=1;
			else if erace~=. then White=0;
		if erace=2 & Latino~=1 then Black=1;
			else if erace~=. then Black=0;
		if erace=3 & Latino~=1 then NativeAmerican=1;
			else if erace~=. then NativeAmerican=0;
		if erace=4 & Latino~=1 then Asian=1;
			else if erace~=. then Asian=0;
		If Asian=1 or NativeAmerican=1 then Other=1;
			else if erace~=. then Other=0;
	*Race catagory;
		race=erace;
		if race=3 then race=5;
		if race=4 then race=5;
		if Latino=1 then race=3;
	*Age;
		if tage>24 & tage<40 then Age25to39=1;
			Else if tage~=. then Age25to39=0;
		if tage>39 & tage<55 then Age40to54=1;
			Else if tage~=. then Age40to54=0;
		if tage>54 then Age55P=1;
			Else if tage~=. then Age55P=0;
		age = tage;
	*Married;
		if ems=1 then Married=1;
			else if ems~=. then Married=0;
	*Children;
		if rfnkids<5 then Children=rfnkids;
			else if rfnkids~=. then Children=5;
		If Children=0 then NoKids=1;
		If Children>0 then Nokids=0;
		HasKids=1-NoKids;
	*Wealth Variables;
		Networth=thhtnw;
		Debt=thhdebt;
		Assets=Networth+Debt;
	*Home and Mortgage;
		HomeEquity=thhtheq;
		HomeDebt=thhmortg;
		if thhtheq~=0 then HomeOwner=1;
			else if thhtheq=. | thhtheq=0 then Homeowner=0;
		if HomeOwner=1 & enummort=. then Mortgages=0;
			else if Homeowner=1 then Mortgages=enummort;
		If Mortgages>4 then Mortgages=4;
		If HomeOwner=0 then Mortgages=0; *Redundant but needed for multiple imputation;
		If HomeDebt~=0 & HomeDebt~=. then HasHomeDebt=1;
			else HasHomeDebt=0;
		HouseValue=thhtheq;
		OtherRealEstateValue=thhore;
		VehicleValue=thhvehcl;
	*Liquid Asset Rates of Ownership; 
		if east3a=1 | east3b=1 then StockMutual=1;
			else if east3a=2 & east3b=2 then StockMutual=0;
		if east2a=1 then InterestBank=1;
			else if east2a=2 then InterestBank=0;
		if ealich=1 then Checking1=1;
			else if ealich=2 then Checking1=0;
		If east1b=1 | east1c=1 then IRAor401k=1;
			Else if east1b=2 | east1c=2 then IRAor401k=0;
		if ebiznow1=1 then BusinessOwner=1;
			else if ebiznow1=2 | ebiznow1=. then BusinessOwner=0;
		if ealli=1 then LifeInsurance=1;
			else if ealli=2 then LifeInsurance=0;
		If ealjdab=0 then CreditCardDebt=0;
			else CreditCardDebt=1;
		if rhhstk~=0 then OtherAssets=1;
			else OtherAssets=0;
	*Liquid Asset Value;
			StockValue=rhhstk;
			InterestBankValue=thhintbk;
			OtherAssetValue=thhotast;
			IraValue=thhira;
			BusinessValue=thhbeq;
			LifeInsuranceValue=talliv;
			CreditCardDebtValue=ealjdab;
	*Vehicle Ownership and Assets;
			NumberCarOwned=eautonum;
			if NumberCarOwned>5 then NumberCarOwned=5;
			if NumberCarOwned=. then OwnCar=0;
			if NumberCarOwned=. then NumberCarOwned=0;
			if eautonum>0 then OwnCar=1;
			if eautonum=. then OwnCar=0;
			if ea1owed=1 | ea2owed=1 | ea3owed=1 then HasCarDebt=1;
				else HasCarDebt=0;
			CarEquity = tcarval1 + tcarval2 + tcarval3;
			CarDebt = ta1amt + ta2amt + ta3amt;
			CarNetEquity = CarEquity - CarDebt;
*New Variables to be matched;
	*Employment;
		if rmesr > 5 then Unemployed=1;
		else if rmesr>0 then Unemployed=0;
	*Financial Assets;
		CheckingValue=taljcha;
		SavingsPlanValue=thhthrif;
		SecuredDebtValue=thhscdbt;

	*Inflate variables by year;
		Array Inflation (22) Income Networth Debt Assets HomeEquity HomeDebt HouseValue OtherRealEstateValue VehicleValue StockValue InterestBankValue OtherAssetValue IraValue BusinessValue LifeInsuranceValue CreditCardDebtValue CarEquity CarDebt CarNetEquity CheckingValue SavingsPlanValue SecuredDebtValue;
		Do i = 1 to 22;
			IF year=1996 then Inflation(i)=Inflation(i)*233.916/154.4;
			IF year=2001 then Inflation(i)=Inflation(i)*233.916/175.1;
			IF year=2004 then Inflation(i)=Inflation(i)*233.916/185.2;
			IF year=2008 then Inflation(i)=Inflation(i)*233.916/214.429;
		END;
*Networth, Assets and Debts Greater than 0.;
		if Networth>0 then AnyNetworth=1;
			else if Networth=<0 & Networth~=. then AnyNetworth=0;	
		if Debt>0 then AnyDebt=1;
			else if Debt=<0 & Debt~=. then AnyDebt=0;	
		if Assets>0 then AnyAssets=1;
			else if Assets=<0 & Assets~=. then AnyAssets=0;	
*Total Financial Assets;
		FinancialAssets=StockValue+InterestBankValue+IraValue+LifeInsuranceValue;
		FinancialAssets1=Assets-HouseValue-OtherRealEstateValue-VehicleValue;
		if FinancialAssets>0 then AnyFinancialAssets=1;
			else if FinancialAssets~=. then AnyFinancialAssets=0;
*US Tenure;
	*1996;
	if year=1996 then do;
		if rmoveus=9999 then rmoveus=.;
		if rmoveus<5 & rmoveus~=. then ustenure25P=1; 
			else if rmoveus~=. | tbrstate<100 then ustenure25P=0; *or statement keeps natives from being ommitted from the regression tables;
		if rmoveus>4 & rmoveus<7 then ustenure11to25=1;
			else if rmoveus~=. | tbrstate<100 then ustenure11to25=0;
		if rmoveus>6 then ustenure0to10=1;
			else if rmoveus~=. | tbrstate<100 then ustenure0to10=0;
	end;
	*2001 and 2004;	
	if year=2001 | year=2004 then do;
	if tmoveus=9999 then tmoveus=.;
		if tmoveus=<7 & tmoveus~=. then ustenure25P=1;
			else if tmoveus~=. | tbrstate<100 then ustenure25P=0;
		if tmoveus>7 & tmoveus<14 then ustenure11to25=1; 
			else if tmoveus~=. | tbrstate<100 then ustenure11to25=0;
		if tmoveus=>14 then ustenure0to10=1;
			else if tmoveus~=. | tbrstate<100 then ustenure0to10=0;
	end;
	if ustenure25P=1 then Tenure='ustenure25P';
			else if ustenure11to25=1 then Tenure='ustenure11to25';
			else If ustenure0to10=1 then Tenure='ustenure0to10';
			else Tenure='ustenure0';
	if tbrstate>100 then immigrant=1;
		else if Tenure='ustenure0' then immigrant =0;
	*Remove 2008;
	if year=2008 then delete;
*match country label in older sipp;
		if  year=1996 then tbrstate=ebrstate;
		if  year=1996 then tprstate=eprstate;
*Family head;
		if efkind=3 then Female=1;
		else if efkind<3 & efkind~=. then Female=0;
		if efkind<2 then MaleHead=1;
		else if efkind~=2 & efkind~=. then MaleHead=0;
		if efkind=1 then JointHead=1;
		else if efkind<1 & efkind~=. then JointHead=0;

*Region;
	if tfipsst=9 | tfipsst=23 | tfipsst=25 | tfipsst=33 | tfipsst=34 | tfipsst=36 | tfipsst=42 | tfipsst=44 | tfipsst=50 then Northeast=1;
		else Northeast=0;
	if tfipsst=17 | tfipsst=18 | tfipsst=19 | tfipsst=20 | tfipsst=26 | tfipsst=27 | tfipsst=29 | tfipsst=31 | tfipsst=38 | tfipsst=39 | tfipsst=46 | tfipsst=55 then Midwest=1;
		else Midwest=0;
	if tfipsst=1 | tfipsst=5 | tfipsst=10 | tfipsst=11 | tfipsst=12 | tfipsst=13 | tfipsst=21 | tfipsst=22 | tfipsst=24 | tfipsst=28 | tfipsst=37 | tfipsst=40 | tfipsst=45 | tfipsst=47 | tfipsst=48 | tfipsst=51 | tfipsst=54 then South=1;
		else South=0; 
	if tfipsst=2 | tfipsst=4 | tfipsst=6 | tfipsst=8 | tfipsst=15 | tfipsst=16 | tfipsst=30 | tfipsst=32 | tfipsst=35 | tfipsst=41 | tfipsst=49 | tfipsst=53 | tfipsst=56 then West=1;
		else West=0;
	if Northeast=0 & Midwest=0 & South=0 & West=0 then OtherRegion=1;
		else OtherRegion=0;
	If Northeast=1 then Region='Northeast';
	if Midwest=1 then Region='Midwest';
	If South=1 then Region='South';
	if West=1 then Region='West';
	If OtherRegion=1 then Region='OtherRegion';
*Year Dummies;
	if year=1996 then year1996=1;
		else year1996=0;
	if year=2001 then year2001=1;
		else year2001=0;
	if year=2004 then year2004=1;
		else year2004=0;

*Networth Brackets;
Array NWBrackets (9) NW21to40 NW41to60 NW61to80 NW81to100 NW101to120 NW121to140 NW141to160 NW161to180 NW181to200;
	Do i = 1 to 9;
		IF networth>(i*20) & networth=<((i+1)*20) then NWBrackets(i)=1;
			else if networth~=. then NWBrackets(i)=0;
		END;
	if networth<0 & networth~=. then NWLessThan0=1;
		else if networth>=0 then NWLessThan0=0;
	if networth=>0 & networth=<20 then NW0to20=1;
		else if networth~=. then NW0to20=0;
	if networth>200 then NWGreaterThan200=1;
		else if networth~=. then NWGreaterThan200=0;
*Debt Brackets;
Array DebtBrackets (9) Debt21to40 Debt41to60 Debt61to80 Debt81to100 Debt101to120 Debt121to140 Debt141to160 Debt161to180 Debt181to200;
	Do i = 1 to 9;
		IF debt>(i*20) & debt=<((i+1)*20) then debtBrackets(i)=1;
			else if debt~=. then debtBrackets(i)=0;
		END;
	if debt<0 then DebtLessThan0=1;
		else if debt>=0 then DebtLessThan0=0;
	if debt=>0 & debt=<20 then Debt0to20=1;
		else if debt~=. then Debt0to20=0;
	if Debt>200 then DebtGreaterThan200=1;
		else if debt~=. then DebtGreaterThan100=0;
*Car Equity Brackets;
Array CarNetEquityBrackets (13) CarNetEquity6to10 CarNetEquity11to15 CarNetEquity16to20 CarNetEquity21to25 CarNetEquity26to30 CarNetEquity31to35 CarNetEquity36to40 CarNetEquity41to45 CarNetEquity46to50 CarNetEquity51to55 CarNetEquity56to60 CarNetEquity61to65 CarNetEquity66to70;
	Do i = 1 to 13;
		IF CarNetEquity>(i*5000) & CarNetEquity=<((i+1)*5000) then CarNetEquityBrackets(i)=1;
			else if CarNetEquity~=. then CarNetEquityBrackets(i)=0;
		END;
	if CarNetEquity>0 & CarNetEquity=<5000 & OwnCar=1 then CarNetEquity0to5=1;
		else if CarNetEquity~=. then CarNetEquity0to5=0;
	if CarNetEquity>70000 then CarNetEquityGreaterThan70=1;
		else if CarNetEquity~=. then CarNetEquityGreaterThan70=0;
	if CarNetEquity=<0 & CarNetEquity>-5000. then CarNetEquity5to0=1;
		else if CarNetEquity~=. then CarNetEquity5to0=0;
	if CarNetEquity=<-5000 & CarNetEquity>-10000 then CarNetEquity10to5=1;
		else if CarNetEquity~=. then CarNetEquity10to5=0;
	if CarNetEquity=<-10000 & CarNetEquity>-15000 then CarNetEquity15to10=1;
		else if CarNetEquity~=. then CarNetEquity15to10=0;
	if CarNetEquity=<-15000 & CarNetEquity>-20000 then CarNetEquity20to15=1;
		else if CarNetEquity~=. then CarNetEquity20to15=0;
	if CarNetEquity=<-20000 & CarNetEquity>-25000 then CarNetEquity25to20=1;
		else if CarNetEquity~=. then CarNetEquity25to20=0;
	if CarNetEquity=<-25000 & CarNetEquity~=. then CarNetEquitylessthan25=1;
		else if CarNetEquity~=. then CarNetEquitylessthan25=0;
	wgt = wpfinwgt;
	if refperson=. then refperson=0;

*Logged Variables;
	Array SkewedVariable (17) income networth debt assets homeequity CheckingValue SavingsPlanValue StockValue IraValue LifeInsuranceValue OtherRealEstateValue BusinessValue OtherAssetValue SecuredDebtValue HomeDebt CreditCardDebtValue CarDebt;
	Array LoggedVariable (17) loggedincome loggednetworth loggeddebt loggedassets loggedhomeequity loggedCheckingValue loggedSavingsPlanValue loggedStockValue loggedIraValue loggedLifeInsuranceValue loggedOtherRealEstateValue loggedBusinessValue loggedOtherAssetValue loggedSecuredDebtValue loggedHomeDebt loggedCreditCardDebtValue loggedCarDebt;
	Do i = 1 to 16;
		if SkewedVariable(i)>0 then LoggedVariable(i)=log10(SkewedVariable(i));  *This without if statement would produce an error and missing number for those with negative and 0 networth.;
		if SkewedVariable(i)<0 then LoggedVariable(i)=-log10(ABS(SkewedVariable(i))); *This gives me negative logged networth;
		if SkewedVariable(i)=0 then LoggedVariable(i)=0; *This is not actually true, but log of 1=0, and 0 is pretty close to 1...;
	END;
*Female=esex-1;
if refperson~=1 then delete;
run;

*Figuring out which variables have a non-normal distribution;
	/*proc univariate plot; var Age Children Networth Debt Assets HomeEquity Mortgages CheckingValue SavingsPlanValue StockValue IraValue LifeInsuranceValue VehicleValue OtherRealEstateValue BusinessValue OtherAssetValue SecuredDebtValue HomeDebt CreditCardDebtValue CarDebt ; run;*/
*Variables with non-normal distributions (skewness>2) based on George and Mallery 2010: networth debt assets homeequity CheckingValue SavingsPlanValue StockValue IraValue LifeInsuranceValue OtherRealEstateValue BusinessValue OtherAssetValue SecuredDebtValue HomeDebt CreditCardDebtValue CarDebt 

*Sort;
	proc sort;
	by year region;
	run;
